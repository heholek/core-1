version: '1.0'

steps:
  main_clone:
    type: git-clone
    repo: open-integration/core
    git: cf_github
    revision: ${{CF_REVISION}}

  test:
    image: golang:1.13.5-alpine3.11
    commands:
    - apk update
    - apk add --no-cache git make ca-certificates gcc g++
    - apk upgrade
    - make test


  version:
    image: codefresh/cli
    commands:
    - cf_export VERSION=$(cat VERSION)    

  git-tag:
    title: Push tag to git
    image: codefresh/cli
    commands:
    - git remote rm origin
    - git remote add origin https://olegsu:${{GITHUB_TOKEN}}@github.com/open-integration/core.git
    - git tag v${{VERSION}}
    - git push --tags
    fail_fast: false
    when:
      branch:
        only:
        - master